{% extends "base.html" %}

{% block title %}Create Trip - WNS Transport Management{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="mb-8">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Create New Trip</h1>
            <p class="text-gray-600 mt-1">Schedule employee transport to WNS Vuram, Whitefield</p>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-sm text-gray-600">Real-time ETA</span>
            </div>
            <a href="/trips/history" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-200">
                <i class="fas fa-history mr-2"></i>View History
            </a>
        </div>
    </div>
</div>

<!-- Progress Steps -->
<div class="mb-8">
    <div class="flex items-center justify-center">
        <div class="flex items-center space-x-4">
            <div class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 bg-wns-blue text-white rounded-full text-sm font-medium" id="step-1-indicator">1</div>
                <span class="ml-2 text-sm font-medium text-wns-blue" id="step-1-text">Trip Details</span>
            </div>
            <div class="w-16 h-0.5 bg-gray-300" id="progress-1-2"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 bg-gray-300 text-gray-500 rounded-full text-sm font-medium" id="step-2-indicator">2</div>
                <span class="ml-2 text-sm font-medium text-gray-500" id="step-2-text">Review & Confirm</span>
            </div>
            <div class="w-16 h-0.5 bg-gray-300" id="progress-2-3"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 bg-gray-300 text-gray-500 rounded-full text-sm font-medium" id="step-3-indicator">3</div>
                <span class="ml-2 text-sm font-medium text-gray-500" id="step-3-text">Confirmation</span>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Trip Creation Form -->
    <div class="lg:col-span-2">
        <!-- Step 1: Trip Details -->
        <div id="step-1" class="bg-white rounded-xl shadow-lg">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Trip Details</h2>
                <p class="text-gray-600 mt-1">Enter the trip information and pickup details</p>
            </div>
            <div class="p-6">
                <form id="trip-form" class="space-y-6">
                    <!-- Employee Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="employee-id" class="block text-sm font-medium text-gray-700 mb-2">
                                Employee ID <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="employee-id" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wns-blue focus:border-transparent"
                                   placeholder="Enter employee ID (e.g., EMP001)">
                            <p class="text-xs text-gray-500 mt-1">Enter your WNS employee ID</p>
                        </div>
                        <div class="relative">
                            <label for="employee-name" class="block text-sm font-medium text-gray-700 mb-2">
                                Employee Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="employee-name" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wns-blue focus:border-transparent"
                                   placeholder="Search by name or ID..."
                                   autocomplete="off">
                            <p class="text-xs text-gray-500 mt-1">Search for employee by name or ID</p>
                            
                            <!-- Employee Search Dropdown -->
                            <div id="employee-dropdown" class="absolute top-full left-0 w-full bg-white border border-gray-300 rounded-lg shadow-lg z-50 hidden max-h-60 overflow-y-auto mt-1">
                                <div id="employee-loading" class="hidden px-4 py-3 text-center text-gray-500">
                                    <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-wns-blue"></div>
                                    <span class="ml-2">Searching...</span>
                                </div>
                                <div id="employee-results" class="divide-y divide-gray-100">
                                    <!-- Search results will be populated here -->
                                </div>
                                <div id="employee-no-results" class="hidden px-4 py-3 text-center text-gray-500">
                                    No employees found
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pickup Location -->
                    <div>
                        <label for="pickup-location" class="block text-sm font-medium text-gray-700 mb-2">
                            Pickup Location <span class="text-red-500">*</span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <select id="pickup-zone" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wns-blue focus:border-transparent">
                                    <option value="">Select Zone</option>
                                    <option value="North">North Zone</option>
                                    <option value="South">South Zone</option>
                                    <option value="East">East Zone</option>
                                    <option value="West">West Zone</option>
                                    <option value="Central">Central Zone</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Choose your pickup zone</p>
                            </div>
                            <div>
                                <select id="pickup-area" required disabled
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wns-blue focus:border-transparent">
                                    <option value="">Select Area</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Specific pickup area</p>
                            </div>
                        </div>
                    </div>

                    <!-- Destination (Read-only) -->
                    <div>
                        <label for="destination" class="block text-sm font-medium text-gray-700 mb-2">
                            Destination
                        </label>
                        <input type="text" id="destination" readonly
                               value="WNS Vuram, Survey No. 12/2, Sy 16/1, Krishnarajapura, Hoodi Circle, Whitefield, Bangalore"
                               class="w-full px-3 py-2 border border-gray-300 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">Fixed destination for all trips</p>
                    </div>

                    <!-- Schedule Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="trip-date" class="block text-sm font-medium text-gray-700 mb-2">
                                Trip Date <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="trip-date" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wns-blue focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Select trip date</p>
                        </div>
                        <div>
                            <label for="pickup-time" class="block text-sm font-medium text-gray-700 mb-2">
                                Pickup Time <span class="text-red-500">*</span>
                            </label>
                            <select id="pickup-time" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wns-blue focus:border-transparent">
                                <option value="">Select Time</option>
                                <option value="07:00">07:00 AM</option>
                                <option value="07:30">07:30 AM</option>
                                <option value="08:00">08:00 AM</option>
                                <option value="08:30">08:30 AM</option>
                                <option value="09:00">09:00 AM</option>
                                <option value="09:30">09:30 AM</option>
                                <option value="10:00">10:00 AM</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Preferred pickup time</p>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                            Additional Notes
                        </label>
                        <textarea id="notes" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wns-blue focus:border-transparent"
                                  placeholder="Any special instructions or requirements..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">Optional: Special instructions for driver</p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-between pt-6">
                        <a href="/dashboard" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                            <i class="fas fa-arrow-left mr-2"></i>Cancel
                        </a>
                        <button type="button" id="next-step" disabled
                                class="bg-wns-blue hover:bg-wns-light-blue text-white px-6 py-2 rounded-lg transition duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed">
                            Next: Review <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Step 2: Review & Confirm -->
        <div id="step-2" class="bg-white rounded-xl shadow-lg hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Review Trip Details</h2>
                <p class="text-gray-600 mt-1">Please review all information before confirming</p>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <!-- Trip Summary -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-900 mb-3">Trip Summary</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Employee:</span>
                                <span class="font-medium ml-2" id="review-employee">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Pickup Location:</span>
                                <span class="font-medium ml-2" id="review-pickup">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Date & Time:</span>
                                <span class="font-medium ml-2" id="review-datetime">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Destination:</span>
                                <span class="font-medium ml-2">WNS Vuram, Whitefield</span>
                            </div>
                        </div>
                    </div>

                    <!-- Estimated Journey Info -->
                    <div class="bg-blue-50 rounded-lg p-4" id="journey-info">
                        <h3 class="font-semibold text-gray-900 mb-3">Estimated Journey Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="eta-time">-</div>
                                <div class="text-gray-600">Travel Time</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="eta-distance">-</div>
                                <div class="text-gray-600">Distance</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600" id="eta-arrival">-</div>
                                <div class="text-gray-600">Est. Arrival</div>
                            </div>
                        </div>
                    </div>

                    <!-- Terms and Conditions -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-yellow-600 mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-yellow-800">Important Notes</h4>
                                <ul class="text-sm text-yellow-700 mt-2 space-y-1">
                                    <li>• Please be ready 5 minutes before pickup time</li>
                                    <li>• Driver will wait maximum 10 minutes at pickup location</li>
                                    <li>• Carry your employee ID for verification</li>
                                    <li>• Trip can be cancelled up to 2 hours before pickup time</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-between pt-6">
                        <button type="button" id="back-step"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition duration-200">
                            <i class="fas fa-arrow-left mr-2"></i>Back
                        </button>
                        <button type="button" id="confirm-trip"
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                            <i class="fas fa-check mr-2"></i>Confirm Trip
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div id="step-3" class="bg-white rounded-xl shadow-lg hidden">
            <div class="p-6 text-center">
                <div class="mb-6">
                    <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-check text-green-600 text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">Trip Created Successfully!</h2>
                    <p class="text-gray-600 mt-2">Your trip has been scheduled and confirmed</p>
                </div>

                <div class="bg-green-50 rounded-lg p-4 mb-6">
                    <div class="text-sm text-green-700">
                        <p><strong>Trip ID:</strong> <span id="trip-id">TRP-12345</span></p>
                        <p><strong>Status:</strong> Confirmed</p>
                        <p><strong>Next Step:</strong> You will receive driver details 30 minutes before pickup</p>
                    </div>
                </div>

                <div class="flex justify-center space-x-4">
                    <a href="/trips/history" class="bg-wns-blue hover:bg-wns-light-blue text-white px-6 py-2 rounded-lg transition duration-200">
                        <i class="fas fa-list mr-2"></i>View My Trips
                    </a>
                    <a href="/trips/create" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                        <i class="fas fa-plus mr-2"></i>Create Another Trip
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Quick Info -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Quick Information</h3>
            <div class="space-y-3 text-sm">
                <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                    <i class="fas fa-clock text-blue-600 mr-3"></i>
                    <div>
                        <div class="font-medium">Pickup Times</div>
                        <div class="text-gray-600">7:00 AM - 10:00 AM</div>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-green-50 rounded-lg">
                    <i class="fas fa-map-marker-alt text-green-600 mr-3"></i>
                    <div>
                        <div class="font-medium">Coverage Zones</div>
                        <div class="text-gray-600">North, South, East, West, Central</div>
                    </div>
                </div>
                <div class="flex items-center p-3 bg-orange-50 rounded-lg">
                    <i class="fas fa-car text-orange-600 mr-3"></i>
                    <div>
                        <div class="font-medium">Vehicle Type</div>
                        <div class="text-gray-600">AC Sedan/SUV</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trips -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Recent Trips</h3>
            <div class="space-y-3" id="recent-trips">
                <div class="text-center text-gray-500 py-4">
                    <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                    <p>Loading recent trips...</p>
                </div>
            </div>
        </div>

        <!-- Help & Support -->
        <div class="bg-wns-blue rounded-xl shadow-lg p-6 text-white">
            <h3 class="text-lg font-bold mb-4">Need Help?</h3>
            <div class="space-y-3">
                <div class="flex items-center">
                    <i class="fas fa-phone mr-3"></i>
                    <div>
                        <div class="font-medium">Transport Helpline</div>
                        <div class="text-blue-100">+91-80-4567-8900</div>
                    </div>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-envelope mr-3"></i>
                    <div>
                        <div class="font-medium">Email Support</div>
                        <div class="text-blue-100">transport@wns.com</div>
                    </div>
                </div>
                <button class="w-full bg-white text-wns-blue py-2 px-4 rounded-lg mt-4 hover:bg-gray-100 transition duration-200">
                    <i class="fas fa-question-circle mr-2"></i>View FAQ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Trip Creation JavaScript
class TripCreator {
    constructor() {
        this.currentStep = 1;
        this.tripData = {};
        this.zoneAreas = {
            'North': ['Hebbal', 'Yelahanka', 'RT Nagar', 'Vidyaranyapura', 'Sahakarnagar'],
            'South': ['Banashankari', 'Jayanagar', 'BTM Layout', 'Koramangala', 'HSR Layout'],
            'East': ['Whitefield', 'Marathahalli', 'Varthur', 'Brookefield', 'ITPL'],
            'West': ['Rajajinagar', 'Vijayanagar', 'Malleshwaram', 'Basaveshwaranagar', 'Mahalakshmi Layout'],
            'Central': ['MG Road', 'Brigade Road', 'Cubbon Park', 'UB City', 'Residency Road']
        };
        this.initializeComponents();
        this.loadRecentTrips();
        this.setMinDate();
        this.prefillEmployeeDetails();
    }

    async prefillEmployeeDetails() {
        // Prefill employee ID and name if logged in
        const user = JSON.parse(localStorage.getItem('user_info') || '{}');
        if (user && user.role === 'employee' && user.email) {
            // Use employee details from user data (should be included in login response now)
            if (user.employee_id && user.employee_name) {
                document.getElementById('employee-id').value = user.employee_id;
                document.getElementById('employee-name').value = user.employee_name;
                
                // Try to get the numeric ID from backend
                try {
                    const res = await fetch('/api/employees/' + encodeURIComponent(user.employee_id));
                    if (res.ok) {
                        const data = await res.json();
                        if (data.employee) {
                            document.getElementById('employee-id').dataset.numericId = data.employee.id;
                            document.getElementById('employee-name').dataset.isValid = 'true';
                        }
                    }
                } catch (e) { /* ignore */ }
                
                document.getElementById('employee-id').readOnly = true;
                document.getElementById('employee-name').readOnly = true;
            } else {
                // Fallback: fetch employee details from backend
                try {
                    const res = await fetch('/api/employees/search?q=' + encodeURIComponent(user.email));
                    if (res.ok) {
                        const data = await res.json();
                        if (data.employees && data.employees.length > 0) {
                            const emp = data.employees[0];
                            document.getElementById('employee-id').value = emp.employee_id;
                            document.getElementById('employee-name').value = emp.name;
                            document.getElementById('employee-id').dataset.numericId = emp.id;
                            document.getElementById('employee-name').dataset.isValid = 'true';
                            document.getElementById('employee-id').readOnly = true;
                            document.getElementById('employee-name').readOnly = true;
                        }
                    }
                } catch (e) { /* ignore */ }
            }
        } else if (user && user.role === 'admin') {
            // For admin, make fields editable and enable search
            document.getElementById('employee-id').readOnly = false;
            document.getElementById('employee-name').readOnly = false;
        }
    }

    initializeComponents() {
        // Employee search functionality
        this.initializeEmployeeSearch();

        // Form field listeners
        document.getElementById('employee-id')?.addEventListener('input', (e) => {
            this.handleEmployeeIdInput(e.target.value);
        });

        document.getElementById('pickup-zone')?.addEventListener('change', (e) => {
            this.updatePickupAreas(e.target.value);
        });

        document.getElementById('pickup-area')?.addEventListener('change', () => {
            this.calculateETA();
        });

        document.getElementById('pickup-time')?.addEventListener('change', () => {
            this.calculateETA();
        });

        // Step navigation
        document.getElementById('next-step')?.addEventListener('click', () => {
            this.goToStep(2);
        });

        document.getElementById('back-step')?.addEventListener('click', () => {
            this.goToStep(1);
        });

        document.getElementById('confirm-trip')?.addEventListener('click', () => {
            this.submitTrip();
        });

        // Form validation
        document.getElementById('trip-form')?.addEventListener('input', () => {
            this.validateForm();
        });
    }

    setMinDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('trip-date').min = today;
        document.getElementById('trip-date').value = today;
    }

    initializeEmployeeSearch() {
        const employeeNameInput = document.getElementById('employee-name');
        const employeeDropdown = document.getElementById('employee-dropdown');
        let searchTimeout;

        // Employee name search
        employeeNameInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                this.hideEmployeeDropdown();
                return;
            }

            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                this.searchEmployees(query);
            }, 300);
        });

        // Handle focus and blur events
        employeeNameInput.addEventListener('focus', () => {
            if (employeeNameInput.value.length >= 2) {
                employeeDropdown.classList.remove('hidden');
            }
        });

        employeeNameInput.addEventListener('blur', (e) => {
            // Delay hiding to allow clicking on dropdown items
            setTimeout(() => {
                if (!employeeDropdown.contains(document.activeElement)) {
                    this.hideEmployeeDropdown();
                }
            }, 150);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!employeeNameInput.contains(e.target) && !employeeDropdown.contains(e.target)) {
                this.hideEmployeeDropdown();
            }
        });
    }

    async searchEmployees(query) {
        const loadingElement = document.getElementById('employee-loading');
        const resultsElement = document.getElementById('employee-results');
        const noResultsElement = document.getElementById('employee-no-results');
        const dropdown = document.getElementById('employee-dropdown');

        // Show loading
        dropdown.classList.remove('hidden');
        loadingElement.classList.remove('hidden');
        resultsElement.innerHTML = '';
        noResultsElement.classList.add('hidden');

        try {
            const response = await fetch(`/api/employees/search?q=${encodeURIComponent(query)}`);
            
            if (response.ok) {
                const data = await response.json();
                this.displayEmployeeResults(data.employees || []);
            } else {
                this.displayEmployeeError();
            }
        } catch (error) {
            console.error('Error searching employees:', error);
            this.displayEmployeeError();
        } finally {
            loadingElement.classList.add('hidden');
        }
    }

    displayEmployeeResults(employees) {
        const resultsElement = document.getElementById('employee-results');
        const noResultsElement = document.getElementById('employee-no-results');

        if (employees.length === 0) {
            noResultsElement.classList.remove('hidden');
            return;
        }

        employees.forEach(employee => {
            const resultItem = document.createElement('div');
            resultItem.className = 'px-4 py-3 cursor-pointer hover:bg-gray-50 transition duration-150';
            resultItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-medium text-gray-900">${employee.name}</div>
                        <div class="text-sm text-gray-500">ID: ${employee.employee_id}</div>
                        <div class="text-xs text-gray-400">${employee.home_location || ''}</div>
                    </div>
                    <div class="text-xs text-gray-400">${employee.phone_number || ''}</div>
                </div>
            `;

            resultItem.addEventListener('click', () => {
                this.selectEmployee(employee);
            });

            resultsElement.appendChild(resultItem);
        });
    }

    displayEmployeeError() {
        const resultsElement = document.getElementById('employee-results');
        resultsElement.innerHTML = `
            <div class="px-4 py-3 text-center text-red-500">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Error searching employees
            </div>
        `;
    }

    selectEmployee(employee) {
        document.getElementById('employee-name').value = employee.name;
        document.getElementById('employee-id').value = employee.employee_id;
        
        // Store the numeric ID for backend submission
        document.getElementById('employee-id').dataset.numericId = employee.id;
        document.getElementById('employee-name').dataset.isValid = 'true';
        
        this.hideEmployeeDropdown();
        this.validateForm();
    }

    hideEmployeeDropdown() {
        document.getElementById('employee-dropdown').classList.add('hidden');
    }

    async handleEmployeeIdInput(employeeId) {
        const employeeNameInput = document.getElementById('employee-name');
        const employeeIdInput = document.getElementById('employee-id');
        
        if (employeeId.length >= 3) {
            try {
                const response = await fetch(`/api/employees/${employeeId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.employee) {
                        employeeNameInput.value = data.employee.name;
                        
                        // Store the numeric ID for backend submission
                        employeeIdInput.dataset.numericId = data.employee.id;
                        employeeNameInput.dataset.isValid = 'true';
                        
                        this.hideEmployeeDropdown();
                    } else {
                        employeeNameInput.value = '';
                        employeeIdInput.dataset.numericId = '';
                        employeeNameInput.dataset.isValid = 'false';
                    }
                } else {
                    employeeNameInput.value = '';
                    employeeIdInput.dataset.numericId = '';
                    employeeNameInput.dataset.isValid = 'false';
                }
            } catch (error) {
                console.error('Error fetching employee:', error);
                employeeNameInput.value = '';
                employeeIdInput.dataset.numericId = '';
                employeeNameInput.dataset.isValid = 'false';
            }
        } else {
            employeeNameInput.value = '';
            employeeIdInput.dataset.numericId = '';
            employeeNameInput.dataset.isValid = 'false';
        }
        this.validateForm();
    }

    updatePickupAreas(zone) {
        const areaSelect = document.getElementById('pickup-area');
        areaSelect.innerHTML = '<option value="">Select Area</option>';
        
        if (zone && this.zoneAreas[zone]) {
            areaSelect.disabled = false;
            this.zoneAreas[zone].forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaSelect.appendChild(option);
            });
        } else {
            areaSelect.disabled = true;
        }
        this.validateForm();
    }

    validateForm() {
        const requiredFields = ['employee-id', 'employee-name', 'pickup-zone', 'pickup-area', 'trip-date', 'pickup-time'];
        const allValid = requiredFields.every(fieldId => {
            const field = document.getElementById(fieldId);
            return field && field.value.trim() !== '';
        });

        // Additional validation for employee ID - check if employee was properly selected
        const employeeId = document.getElementById('employee-id').value.trim();
        const employeeName = document.getElementById('employee-name').value.trim();
        const employeeIdField = document.getElementById('employee-id');
        const employeeNameField = document.getElementById('employee-name');
        
        // Valid if both employee ID and name are provided and a numeric ID is stored
        const hasNumericId = employeeIdField.dataset.numericId && employeeIdField.dataset.numericId !== '';
        const isValidEmployeeId = employeeId && employeeName && hasNumericId;

        const isFormValid = allValid && isValidEmployeeId;
        document.getElementById('next-step').disabled = !isFormValid;

        // Update button text based on validation state
        console.log(employeeId, employeeName, hasNumericId, isValidEmployeeId);
        const nextButton = document.getElementById('next-step');
        if (!isValidEmployeeId) {
            nextButton.textContent = 'Please select valid employee';
        } else {
            nextButton.textContent = 'Review Trip Details';
        }
    }

    async calculateETA() {
        const zone = document.getElementById('pickup-zone').value;
        const area = document.getElementById('pickup-area').value;
        const time = document.getElementById('pickup-time').value;

        if (zone && area && time) {
            try {
                const response = await fetch(`/api/eta/calculate?pickup_location=${area}&shift_time=${time}`);
                if (response.ok) {
                    const data = await response.json();
                    this.updateETADisplay(data);
                }
            } catch (error) {
                console.error('Error calculating ETA:', error);
                this.updateETADisplay({
                    travel_time: '45 mins',
                    distance: '15 km',
                    arrival_time: '09:45 AM'
                });
            }
        }
    }

    updateETADisplay(data) {
        document.getElementById('eta-time').textContent = data.travel_time || '45 mins';
        document.getElementById('eta-distance').textContent = data.distance || '15 km';
        document.getElementById('eta-arrival').textContent = data.arrival_time || '09:45 AM';
    }

    goToStep(step) {
        // Hide current step
        document.getElementById(`step-${this.currentStep}`).classList.add('hidden');
        
        // Update step indicators
        this.updateStepIndicators(step);
        
        if (step === 2) {
            this.populateReviewStep();
        }
        
        // Show new step
        document.getElementById(`step-${step}`).classList.remove('hidden');
        this.currentStep = step;
    }

    updateStepIndicators(activeStep) {
        for (let i = 1; i <= 3; i++) {
            const indicator = document.getElementById(`step-${i}-indicator`);
            const text = document.getElementById(`step-${i}-text`);
            const progress = document.getElementById(`progress-${i}-${i+1}`);
            
            if (i <= activeStep) {
                indicator.classList.remove('bg-gray-300', 'text-gray-500');
                indicator.classList.add('bg-wns-blue', 'text-white');
                text.classList.remove('text-gray-500');
                text.classList.add('text-wns-blue');
                
                if (progress) {
                    progress.classList.remove('bg-gray-300');
                    progress.classList.add('bg-wns-blue');
                }
            } else {
                indicator.classList.remove('bg-wns-blue', 'text-white');
                indicator.classList.add('bg-gray-300', 'text-gray-500');
                text.classList.remove('text-wns-blue');
                text.classList.add('text-gray-500');
                
                if (progress) {
                    progress.classList.remove('bg-wns-blue');
                    progress.classList.add('bg-gray-300');
                }
            }
        }
    }

    populateReviewStep() {
        const employeeId = document.getElementById('employee-id').value;
        const employeeName = document.getElementById('employee-name').value;
        const zone = document.getElementById('pickup-zone').value;
        const area = document.getElementById('pickup-area').value;
        const date = document.getElementById('trip-date').value;
        const time = document.getElementById('pickup-time').value;

        document.getElementById('review-employee').textContent = `${employeeName} (${employeeId})`;
        document.getElementById('review-pickup').textContent = `${area}, ${zone} Zone`;
        document.getElementById('review-datetime').textContent = `${date} at ${time}`;

        this.calculateETA();
    }

    async submitTrip() {
        // Validate employee data before submission
        const employeeIdField = document.getElementById('employee-id');
        const employeeNameField = document.getElementById('employee-name');
        
        if (!employeeIdField.value || !employeeNameField.value) {
            alert('Please select a valid employee using the search functionality.');
            return;
        }

        // Use the stored numeric ID for backend submission
        const numericEmployeeId = employeeIdField.dataset.numericId;
        if (!numericEmployeeId || numericEmployeeId === '') {
            alert('Invalid employee selection. Please select an employee from the search results.');
            return;
        }

        const employeeId = parseInt(numericEmployeeId);
        if (isNaN(employeeId)) {
            alert('Invalid employee ID. Please select an employee from the search results.');
            return;
        }

        const tripData = {
            employee_id: employeeId,
            pickup_location: `${document.getElementById('pickup-area').value}, ${document.getElementById('pickup-zone').value} Zone`,
            destination: document.getElementById('destination').value,
            scheduled_time: `${document.getElementById('trip-date').value} ${document.getElementById('pickup-time').value}`,
            notes: document.getElementById('notes').value || ''
        };

        // Get logged-in user info for headers
        const user = JSON.parse(localStorage.getItem('user_info') || '{}');
        const userId = user.id || employeeId;
        const userRole = user.role || 'employee';
        const userEmail = user.email || '';

        try {
            const response = await fetch('/api/trips/enhanced', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-user-id': userId,
                    'x-user-role': userRole,
                    'x-user-email': userEmail
                },
                body: JSON.stringify(tripData)
            });

            if (response.ok) {
                const result = await response.json();
                document.getElementById('trip-id').textContent = result.trip_id || 'TRP-12345';
                this.goToStep(3);
                // If admin, refresh admin dashboard recent trips
                if (userRole === 'admin' && window.refreshAdminRecentTrips) {
                    window.refreshAdminRecentTrips();
                }
            } else {
                const errorData = await response.json();
                console.error('Server error:', errorData);
                throw new Error(errorData.detail || 'Failed to create trip');
            }
        } catch (error) {
            console.error('Error creating trip:', error);
            alert(`Error creating trip: ${error.message}. Please try again.`);
        }
    }

    async loadRecentTrips() {
        try {
            const response = await fetch('/api/trips/recent?limit=3');
            const recentTripsContainer = document.getElementById('recent-trips');
            
            if (response.ok) {
                const trips = await response.json();
                if (trips && trips.length > 0) {
                    recentTripsContainer.innerHTML = trips.map(trip => `
                        <div class="border border-gray-200 rounded-lg p-3">
                            <div class="text-sm">
                                <div class="font-medium text-gray-900">${trip.pickup_location}</div>
                                <div class="text-gray-600">${trip.date} • ${trip.status}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    recentTripsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No recent trips</p>';
                }
            }
        } catch (error) {
            console.error('Error loading recent trips:', error);
            document.getElementById('recent-trips').innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Unable to load recent trips</p>';
        }
    }
}

// Initialize trip creator when page loads
document.addEventListener('DOMContentLoaded', () => {
    const tripCreator = new TripCreator();
    // Pre-select zone if provided in query params
    const params = new URLSearchParams(window.location.search);
    const zone = params.get('zone');
    if (zone) {
        const zoneSelect = document.getElementById('pickup-zone');
        if (zoneSelect) {
            zoneSelect.value = zone;
            // Trigger area update logic
            tripCreator.updatePickupAreas(zone);
        }
    }
});
</script>
{% endblock %}