{% extends "base.html" %}

{% block title %}Live Tracking - WNS Transport Management{% endblock %}

{% block extra_css %}
<style>
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .tracking-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="mb-8">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">
                <i class="fas fa-location-arrow text-wns-blue mr-3"></i>
                Live Trip Tracking
            </h1>
            <p class="text-gray-600 mt-1">Real-time monitoring of active trips in Bangalore</p>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-sm text-gray-600">Live Updates</span>
            </div>
            <a href="/trips/history" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-200">
                <i class="fas fa-history mr-2"></i>Trip History
            </a>
        </div>
    </div>
</div>

        <!-- Trip Selection & Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Trip Selection -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-search text-wns-blue mr-2"></i>
                    Select Trip to Track
                </h3>
                
                <!-- Trip Filter -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                    <select id="status-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-wns-blue">
                        <option value="all">All Trips</option>
                        <option value="in_progress">In Progress</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>

                <!-- Active Trips List -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Active Trips</label>
                    <div id="trips-list" class="space-y-2 max-h-48 overflow-y-auto">
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                            <p>Loading trips...</p>
                        </div>
                    </div>
                </div>

                <button id="start-tracking-btn" class="w-full bg-wns-blue hover:bg-wns-light-blue text-white px-4 py-2 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-play mr-2"></i>Start Live Tracking
                </button>
            </div>

            <!-- Trip Details -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-info-circle text-wns-blue mr-2"></i>
                    Trip Details
                </h3>
                <div id="trip-details">
                    <p class="text-gray-500 text-center py-8">Select a trip to view details</p>
                </div>
            </div>

            <!-- Live Status -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-broadcast-tower text-wns-blue mr-2"></i>
                    Live Status
                </h3>
                <div id="live-status">
                    <div class="text-center py-4">
                        <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                            <i class="fas fa-circle text-gray-400 mr-2"></i>
                            Not Tracking
                        </div>
                        <p class="text-gray-500 mt-2 text-sm">No active tracking session</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map and Tracking Interface -->
        <div id="tracking-interface" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Map View -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="flex justify-between items-center p-4 bg-gray-50 border-b">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-map text-wns-blue mr-2"></i>
                                Live Location
                            </h3>
                            <div class="flex items-center space-x-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 pulse">
                                    <i class="fas fa-circle text-green-400 mr-1"></i>
                                    Live
                                </span>
                                <button id="refresh-map-btn" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="relative">
                            <div id="tracking-map" style="height: 500px;"></div>
                            <div class="tracking-indicator">
                                <div class="bg-white rounded-lg shadow-lg p-3">
                                    <div class="text-xs text-gray-600">Last Update</div>
                                    <div id="last-update" class="text-sm font-medium">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tracking Info Panel -->
                <div class="space-y-6">
                    <!-- Progress Card -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-route text-wns-blue mr-2"></i>
                            Trip Progress
                        </h4>
                        
                        <!-- Progress Bar -->
                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>Progress</span>
                                <span id="progress-percentage">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progress-bar" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- ETA Info -->
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <div class="text-blue-600 font-semibold" id="eta-time">--:--</div>
                                <div class="text-xs text-gray-600">ETA</div>
                            </div>
                            <div class="bg-orange-50 p-3 rounded-lg">
                                <div class="text-orange-600 font-semibold" id="time-remaining">-- min</div>
                                <div class="text-xs text-gray-600">Remaining</div>
                            </div>
                        </div>

                        <!-- Distance Info -->
                        <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                            <div class="bg-green-50 p-3 rounded-lg">
                                <div class="text-green-600 font-semibold" id="distance-covered">0 km</div>
                                <div class="text-xs text-gray-600">Covered</div>
                            </div>
                            <div class="bg-red-50 p-3 rounded-lg">
                                <div class="text-red-600 font-semibold" id="distance-remaining">-- km</div>
                                <div class="text-xs text-gray-600">Remaining</div>
                            </div>
                        </div>
                    </div>

                    <!-- Driver Info Card -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-user text-wns-blue mr-2"></i>
                            Driver Information
                        </h4>
                        <div id="driver-info">
                            <p class="text-gray-500">No driver assigned</p>
                        </div>
                        <div class="mt-4 space-y-2">
                            <button id="contact-driver-btn" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-phone mr-2"></i>Contact Driver
                            </button>
                            <button id="report-issue-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-200">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Report Issue
                            </button>
                        </div>
                    </div>

                    <!-- Live Updates Card -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-rss text-wns-blue mr-2"></i>
                            Live Updates
                        </h4>
                        <div id="live-updates" class="space-y-2 max-h-32 overflow-y-auto">
                            <p class="text-gray-500 text-sm">No updates yet</p>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-cog text-wns-blue mr-2"></i>
                            Controls
                        </h4>
                        <div class="space-y-2">
                            <button id="stop-tracking-btn" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                                <i class="fas fa-stop mr-2"></i>Stop Tracking
                            </button>
                            <button id="share-location-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200">
                                <i class="fas fa-share mr-2"></i>Share Location
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <!-- Traffic Status -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-traffic-light text-wns-blue mr-2"></i>
                    Traffic Status
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <i class="fas fa-road fa-2x text-red-500 mb-2"></i>
                        <div class="text-sm font-medium">Outer Ring Road</div>
                        <span class="inline-block px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Heavy</span>
                    </div>
                    <div class="text-center">
                        <i class="fas fa-road fa-2x text-green-500 mb-2"></i>
                        <div class="text-sm font-medium">Whitefield Road</div>
                        <span class="inline-block px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Light</span>
                    </div>
                </div>
            </div>

            <!-- Today's Summary -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-chart-bar text-wns-blue mr-2"></i>
                    Today's Summary
                </h3>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div>
                        <i class="fas fa-check-circle text-green-500 text-lg mb-1"></i>
                        <div class="text-lg font-semibold" id="completed-count">0</div>
                        <div class="text-xs text-gray-600">Completed</div>
                    </div>
                    <div>
                        <i class="fas fa-car text-blue-500 text-lg mb-1"></i>
                        <div class="text-lg font-semibold" id="active-count">0</div>
                        <div class="text-xs text-gray-600">Active</div>
                    </div>
                    <div>
                        <i class="fas fa-clock text-yellow-500 text-lg mb-1"></i>
                        <div class="text-lg font-semibold" id="pending-count">0</div>
                        <div class="text-xs text-gray-600">Pending</div>
                    </div>
                </div>
            </div>

            <!-- Performance -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-tachometer-alt text-wns-blue mr-2"></i>
                    Performance
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Avg Trip Time</span>
                        <span class="text-sm font-medium" id="avg-trip-time">-- min</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">On-time Rate</span>
                        <span class="text-sm font-medium" id="ontime-rate">--%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Driver Rating</span>
                        <span class="text-sm font-medium" id="driver-rating">
                            <i class="fas fa-star text-yellow-400"></i> --
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
            <div class="flex items-center">
                <div id="notification-icon" class="mr-3"></div>
                <div>
                    <div id="notification-title" class="text-sm font-medium text-gray-900"></div>
                    <div id="notification-message" class="text-sm text-gray-600"></div>
                </div>
                <button onclick="hideNotification()" class="ml-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    class TripTracker {
            constructor() {
                this.currentTripId = null;
                this.trackingMap = null;
                this.driverMarker = null;
                this.routeLine = null;
                this.trackingInterval = null;
                this.webSocket = null;
                this.currentUser = this.getUserInfo();
                
                this.init();
            }

            getUserInfo() {
                const userInfo = localStorage.getItem('user_info');
                if (userInfo) {
                    try {
                        return JSON.parse(userInfo);
                    } catch (e) {
                        console.error('Failed to parse user info:', e);
                    }
                }
                return { role: 'employee', id: 1, email: 'user@travel.com' };
            }

            init() {
                this.bindEvents();
                this.loadTrips();
                this.loadSummaryData();
            }

            bindEvents() {
                document.getElementById('status-filter').addEventListener('change', () => {
                    this.loadTrips();
                });

                document.getElementById('start-tracking-btn').addEventListener('click', () => {
                    this.startTracking();
                });

                document.getElementById('stop-tracking-btn').addEventListener('click', () => {
                    this.stopTracking();
                });

                document.getElementById('refresh-map-btn').addEventListener('click', () => {
                    this.refreshMap();
                });

                document.getElementById('contact-driver-btn').addEventListener('click', () => {
                    this.contactDriver();
                });

                document.getElementById('report-issue-btn').addEventListener('click', () => {
                    this.reportIssue();
                });

                document.getElementById('share-location-btn').addEventListener('click', () => {
                    this.shareLocation();
                });
            }

            async loadTrips() {
                const statusFilter = document.getElementById('status-filter').value;
                const tripsList = document.getElementById('trips-list');
                
                tripsList.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                        <p>Loading trips...</p>
                    </div>
                `;

                try {
                    const params = new URLSearchParams({
                        user_id: this.currentUser.id || 1,
                        role: this.currentUser.role || 'employee',
                        status: statusFilter === 'all' ? 'in_progress,pending' : statusFilter
                    });

                    const response = await fetch(`/api/trips/history?${params}`);
                    const data = await response.json();
                    
                    this.displayTrips(data.trips || []);

                } catch (error) {
                    console.error('Error loading trips:', error);
                    tripsList.innerHTML = `
                        <div class="text-center py-4 text-red-500">
                            <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                            <p>Failed to load trips</p>
                        </div>
                    `;
                }
            }

            displayTrips(trips) {
                const tripsList = document.getElementById('trips-list');
                
                if (trips.length === 0) {
                    tripsList.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-info-circle text-xl mb-2"></i>
                            <p>No active trips found</p>
                        </div>
                    `;
                    return;
                }

                tripsList.innerHTML = '';
                
                trips.forEach(trip => {
                    const tripElement = this.createTripElement(trip);
                    tripsList.appendChild(tripElement);
                });
            }

            createTripElement(trip) {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition duration-200';
                div.onclick = () => this.selectTrip(trip);

                const statusColor = this.getStatusColor(trip.status);
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-sm font-medium text-gray-900">Trip #${trip.id}</div>
                        <span class="inline-block px-2 py-1 text-xs rounded-full ${statusColor}">
                            ${trip.status || 'unknown'}
                        </span>
                    </div>
                    <div class="text-xs text-gray-600 mb-1">
                        <i class="fas fa-map-marker-alt text-green-500 mr-1"></i>
                        ${this.truncateText(trip.pickup_location || 'Unknown', 20)}
                    </div>
                    <div class="text-xs text-gray-600">
                        <i class="fas fa-flag-checkered text-red-500 mr-1"></i>
                        ${this.truncateText(trip.destination || 'Unknown', 20)}
                    </div>
                `;

                return div;
            }

            selectTrip(trip) {
                this.currentTripId = trip.id;
                this.displayTripDetails(trip);
                
                // Enable tracking button
                document.getElementById('start-tracking-btn').disabled = false;
                
                // Highlight selected trip
                document.querySelectorAll('#trips-list > div').forEach(el => {
                    el.classList.remove('border-wns-blue', 'bg-blue-50');
                    el.classList.add('border-gray-200');
                });
                
                event.currentTarget.classList.remove('border-gray-200');
                event.currentTarget.classList.add('border-wns-blue', 'bg-blue-50');
            }

            displayTripDetails(trip) {
                const detailsContainer = document.getElementById('trip-details');
                
                detailsContainer.innerHTML = `
                    <div class="space-y-3">
                        <div>
                            <div class="text-sm font-medium text-gray-900">Trip ID</div>
                            <div class="text-sm text-gray-600">#${trip.id}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">Employee</div>
                            <div class="text-sm text-gray-600">${trip.employee_name || trip.employee_id || 'N/A'}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">Pickup Location</div>
                            <div class="text-sm text-gray-600">${trip.pickup_location || 'N/A'}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">Destination</div>
                            <div class="text-sm text-gray-600">${trip.destination || 'N/A'}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">Scheduled Time</div>
                            <div class="text-sm text-gray-600">${this.formatDateTime(trip.scheduled_time)}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">Status</div>
                            <span class="inline-block px-2 py-1 text-xs rounded-full ${this.getStatusColor(trip.status)}">
                                ${trip.status || 'unknown'}
                            </span>
                        </div>
                    </div>
                `;
            }

            async startTracking() {
                if (!this.currentTripId) return;

                // Show tracking interface
                document.getElementById('tracking-interface').classList.remove('hidden');
                
                // Initialize map
                this.initializeMap();
                
                // Update live status
                this.updateLiveStatus('tracking', 'Tracking Active');
                
                // Start WebSocket connection for real-time updates
                this.connectWebSocket();
                
                // Start periodic updates
                this.startPeriodicUpdates();
                
                this.showNotification('Tracking started successfully', 'success');
            }

            initializeMap() {
                // Bangalore center coordinates
                const bangaloreCenter = [12.9716, 77.5946];
                
                if (this.trackingMap) {
                    this.trackingMap.remove();
                }
                
                this.trackingMap = L.map('tracking-map').setView(bangaloreCenter, 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(this.trackingMap);
                
                // Add demo markers for visualization
                this.addDemoMarkers();
            }

            addDemoMarkers() {
                // Demo pickup location (Yelahanka)
                const pickupMarker = L.marker([13.1056, 77.5945])
                    .addTo(this.trackingMap)
                    .bindPopup('<b>Pickup Location</b><br>Yelahanka New Town');
                
                // Demo destination (Whitefield)
                const destMarker = L.marker([12.9698, 77.7500])
                    .addTo(this.trackingMap)
                    .bindPopup('<b>Destination</b><br>WNS Vuram, Whitefield');
                
                // Demo current location (moving)
                this.driverMarker = L.marker([13.0500, 77.6200], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(this.trackingMap)
                  .bindPopup('<b>Driver Location</b><br>Current position');
                
                // Demo route line
                this.routeLine = L.polyline([
                    [13.1056, 77.5945],
                    [13.0500, 77.6200],
                    [12.9698, 77.7500]
                ], {color: 'blue', weight: 4}).addTo(this.trackingMap);
                
                // Fit map to show all markers
                const group = new L.featureGroup([pickupMarker, destMarker, this.driverMarker]);
                this.trackingMap.fitBounds(group.getBounds().pad(0.1));
            }

            connectWebSocket() {
                if (this.webSocket) {
                    this.webSocket.close();
                }
                
                try {
                    this.webSocket = new WebSocket(`ws://localhost:5001/ws/${this.currentTripId}`);
                    
                    this.webSocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketUpdate(data);
                    };
                    
                    this.webSocket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.showNotification('Real-time connection failed', 'error');
                    };
                    
                } catch (error) {
                    console.error('Failed to connect WebSocket:', error);
                }
            }

            handleWebSocketUpdate(data) {
                // Update last update time
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                
                // Add live update
                this.addLiveUpdate(`Location updated: ${data.message || 'Position updated'}`);
                
                // Update progress if available
                if (data.progress !== undefined) {
                    this.updateProgress(data.progress);
                }
            }

            startPeriodicUpdates() {
                if (this.trackingInterval) {
                    clearInterval(this.trackingInterval);
                }
                
                this.trackingInterval = setInterval(() => {
                    this.simulateMovement();
                    this.updateLastUpdateTime();
                }, 5000); // Update every 5 seconds
            }

            simulateMovement() {
                // Demo: Simulate driver movement
                if (this.driverMarker) {
                    const currentPos = this.driverMarker.getLatLng();
                    const destLat = 12.9698;
                    const destLng = 77.7500;
                    
                    // Move slightly towards destination
                    const newLat = currentPos.lat + (destLat - currentPos.lat) * 0.02;
                    const newLng = currentPos.lng + (destLng - currentPos.lng) * 0.02;
                    
                    this.driverMarker.setLatLng([newLat, newLng]);
                    
                    // Update route line
                    if (this.routeLine) {
                        const routePoints = this.routeLine.getLatLngs();
                        routePoints[1] = L.latLng(newLat, newLng);
                        this.routeLine.setLatLngs(routePoints);
                    }
                    
                    // Update progress
                    const progress = Math.min(Math.random() * 100, 95);
                    this.updateProgress(progress);
                }
            }

            updateProgress(progress) {
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-percentage').textContent = Math.round(progress) + '%';
                
                // Update ETA based on progress
                const remainingTime = Math.round((100 - progress) * 0.5); // Rough calculation
                document.getElementById('time-remaining').textContent = remainingTime + ' min';
                
                const eta = new Date(Date.now() + remainingTime * 60000);
                document.getElementById('eta-time').textContent = eta.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Update distances
                const totalDistance = 25; // Demo: 25km total
                const covered = (progress / 100) * totalDistance;
                document.getElementById('distance-covered').textContent = covered.toFixed(1) + ' km';
                document.getElementById('distance-remaining').textContent = (totalDistance - covered).toFixed(1) + ' km';
            }

            updateLastUpdateTime() {
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            }

            addLiveUpdate(message) {
                const updatesContainer = document.getElementById('live-updates');
                
                const updateElement = document.createElement('div');
                updateElement.className = 'text-sm p-2 bg-gray-50 rounded border-l-4 border-green-400';
                updateElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-green-500 mr-2">●</span>
                        <span>${message}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Just now</div>
                `;
                
                updatesContainer.insertBefore(updateElement, updatesContainer.firstChild);
                
                // Keep only last 5 updates
                while (updatesContainer.children.length > 5) {
                    updatesContainer.removeChild(updatesContainer.lastChild);
                }
            }

            updateLiveStatus(status, message) {
                const statusContainer = document.getElementById('live-status');
                
                let statusClass, icon;
                switch(status) {
                    case 'tracking':
                        statusClass = 'bg-green-100 text-green-800';
                        icon = 'fas fa-circle text-green-400';
                        break;
                    case 'error':
                        statusClass = 'bg-red-100 text-red-800';
                        icon = 'fas fa-circle text-red-400';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800';
                        icon = 'fas fa-circle text-gray-400';
                }
                
                statusContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                            <i class="${icon} mr-2 ${status === 'tracking' ? 'pulse' : ''}"></i>
                            ${status === 'tracking' ? 'Live Tracking' : 'Not Tracking'}
                        </div>
                        <p class="text-gray-500 mt-2 text-sm">${message}</p>
                    </div>
                `;
            }

            stopTracking() {
                if (this.trackingInterval) {
                    clearInterval(this.trackingInterval);
                    this.trackingInterval = null;
                }
                
                if (this.webSocket) {
                    this.webSocket.close();
                    this.webSocket = null;
                }
                
                // Hide tracking interface
                document.getElementById('tracking-interface').classList.add('hidden');
                
                // Update live status
                this.updateLiveStatus('stopped', 'Tracking stopped');
                
                // Reset current trip
                this.currentTripId = null;
                document.getElementById('start-tracking-btn').disabled = true;
                
                this.showNotification('Tracking stopped', 'info');
            }

            refreshMap() {
                if (this.trackingMap) {
                    this.trackingMap.invalidateSize();
                    this.showNotification('Map refreshed', 'success');
                }
            }

            contactDriver() {
                this.showNotification('Calling driver...', 'info');
                // In a real app, this would initiate a phone call
            }

            reportIssue() {
                this.showNotification('Issue report submitted', 'warning');
                // In a real app, this would open an issue form
            }

            shareLocation() {
                if (navigator.share) {
                    navigator.share({
                        title: 'Trip Location',
                        text: 'Current trip location',
                        url: window.location.href
                    });
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(window.location.href);
                    this.showNotification('Location link copied to clipboard', 'success');
                }
            }

            async loadSummaryData() {
                try {
                    // Load summary statistics
                    const response = await fetch('/api/dashboard/stats');
                    const data = await response.json();
                    
                    // Update counts
                    document.getElementById('completed-count').textContent = data.completed_trips || 0;
                    document.getElementById('active-count').textContent = data.active_trips || 0;
                    document.getElementById('pending-count').textContent = data.pending_trips || 0;
                    
                    // Update performance metrics
                    document.getElementById('avg-trip-time').textContent = (data.avg_trip_time || 28) + ' min';
                    document.getElementById('ontime-rate').textContent = (data.ontime_rate || 85) + '%';
                    document.getElementById('driver-rating').innerHTML = `<i class="fas fa-star text-yellow-400"></i> ${data.driver_rating || 4.2}`;
                    
                } catch (error) {
                    console.error('Error loading summary data:', error);
                }
            }

            // Utility methods
            getStatusColor(status) {
                const colors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'in_progress': 'bg-blue-100 text-blue-800', 
                    'completed': 'bg-green-100 text-green-800',
                    'cancelled': 'bg-red-100 text-red-800'
                };
                return colors[status] || 'bg-gray-100 text-gray-800';
            }

            truncateText(text, maxLength) {
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            formatDateTime(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString();
                } catch (e) {
                    return 'Invalid Date';
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                const icon = document.getElementById('notification-icon');
                const title = document.getElementById('notification-title');
                const messageEl = document.getElementById('notification-message');

                const config = {
                    success: { icon: 'fas fa-check-circle text-green-500', title: 'Success' },
                    error: { icon: 'fas fa-exclamation-circle text-red-500', title: 'Error' },
                    warning: { icon: 'fas fa-exclamation-triangle text-yellow-500', title: 'Warning' },
                    info: { icon: 'fas fa-info-circle text-blue-500', title: 'Info' }
                };

                const cfg = config[type] || config.info;
                icon.innerHTML = `<i class="${cfg.icon}"></i>`;
                title.textContent = cfg.title;
                messageEl.textContent = message;

                notification.classList.remove('hidden');

                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 5000);
            }
        }

        // Global functions
        function hideNotification() {
            document.getElementById('notification').classList.add('hidden');
        }

        // Initialize when page loads
        let tripTracker;
        document.addEventListener('DOMContentLoaded', function() {
            tripTracker = new TripTracker();
        });
    </script>
{% endblock %}